# Bivariate models {#bivariate-models}


```{r setup, include = FALSE}
  knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
  )
  library(RJafroc)
  library(ggplot2)
  library(mvtnorm)
  library(gridExtra)
  library(grid)
  library(png)
  library(plot3D)
  library(plotly)
```


## How much finished 30% {#bivariate-models-how-much-finished}



## Introduction {#bivariate-models-introduction}

Until now the focus has been on the single rating per case scenario where a reader interprets a set of cases in a single modality. This chapter describes two approaches to the problem of two readers interpreting a common set of cases. Because of the paired interpretation the two ratings per case are correlated. The first approach extends the binormal model to paired interpretations while the second extends the contaminated binormal model to paired interpretations. The corresponding software implementations are CORROC2 and CORCBM, respectively.


In [@chakraborty2017observer] Chapter 21 was devoted to the CORROC2 algorithm and usage of the software was described in detail. At that time [@zhai2017bivariate] was in press. This paper describes an alternate algorithm -- termed the correlated contaminated binormal model as implemented in CORCBM software -- that has several advantages over CORROC2. Therefore, I have reconsidered the focus of this chapter which now outlines the correlated binormal model fitting procedure but does not detail how to use CORROC2 software. Instead I now include the work presented in [@zhai2017bivariate] but using clearer notation and how to use the CORCBM software implementing it. The included description of the CORROC2 model - basically how to extend the binormal model to a correlated binormal model - will help the reader better understand how to extend the contaminated binormal model to the correlated contaminated binormal model. 


This chapter consists of two sections ... TBA
The bivariate binormal model
The bivariate contaminated binormal model

In this chapter the bivariate extension of the (univariate) binormal model is described. Bivariate sampling is described at a relatively simple level. Interactive visualization of the probability density functions is demonstrated. Estimation of parameters of the bivariate binormal model from ratings data is addressed. 


## The bivariate binormal model {#bivariate-models-binormal}

### The bivariate normal distribution

Sampling from the bivariate normal distribution $N_2$ is as follows:


\begin{equation}
\overrightarrow{z} \sim  N_2\left( \overrightarrow{\mu}, \Sigma \right)
(\#eq:multivariate-sampling-model)
\end{equation} 


Here $\overrightarrow{z}$ is a length-$2$ vector, with components $(z_1,z_2)$, of the observed z-samples for each case, $\overrightarrow{\mu}$ is a length-$2$ vector containing the means of the bivariate normal distribution and $\Sigma$ is the $2 \times 2$ covariance matrix describing the variances and correlations of the observed z-samples. 


The bivariate normal probability density function $\text{pdf}\left( \overrightarrow{z} ~~ \bigg \rvert ~~\overrightarrow{\mu}, ~~ \Sigma \right)$ is defined by:


\begin{equation} 
\text{pdf}\left( z_1,z_2 ~~ \bigg \rvert ~~ \overrightarrow{\mu}, \Sigma \right)
= \frac{1}{2 \pi \sigma_{12} \sigma_{22} \sqrt{1-\rho^2}}\exp\left( -\frac{t}{2\left( 1-\rho^2 \right)} \right)
(\#eq:bivariate-models-binormal-density-function)
\end{equation} 


where


\begin{equation} 
t=\frac{\left( z_1-\mu_{12} \right)^2}{\sigma_{12}^2}-\frac{2\rho\left( z_1-\mu_{12} \right)\left( z_2-\mu_{22} \right)}{\sigma_{12} \sigma_{22}}
+\frac{\left( z_2-\mu_{22} \right)^2}{\sigma_{22}^2}
(\#eq:bivariate-models-binormal-density-function2)
\end{equation} 



For a bivariate distribution the covariance matrix is: 


\begin{equation} 
\Sigma=
\left( \begin{matrix}
\sigma_{12}^2 & \rho \sigma_{12} \sigma_{22} \\
\rho \sigma_{12} \sigma_{22} & 
\sigma_{22}^2
\end{matrix}
 \right)(\#eq:bivariate-models-binormal-covariance-matrix)
\end{equation} 


In these equations $\mu_{12}$ and $\sigma_{12}^2$ is the mean and variance for modality 1, $\mu_{22}$ and $\sigma_{22}^2$ is the mean and variance for modality 2 and $\rho$ is the correlation between the two modalities.

The `R` function to evaluate Eqn. \@ref(eq:bivariate-models-binormal-density-function) is `dmvnorm()`, for “density of multivariate normal distribution” available via `R` package `mvtnorm` [@R-mvtnorm]. Its usage is illustrated next for the following parameter values:


\begin{equation} 
\left.\begin{aligned}
\overrightarrow{
\mu}&=
\left( \begin{matrix}
\mu_{12} \\
\mu_{22}
\end{matrix}
\right)
=\left( \begin{matrix}
1.5 \\
2.0
\end{matrix}
\right) \\
\sigma_{12} &= 1.1 \\
\sigma_{22} &= 1.5 \\
\rho &= 0.6 \\
\Sigma&=
\left( 
\begin{matrix}
\sigma_{12}^2 & \rho \sigma_{12} \sigma_{22} \\
\rho \sigma_{12} \sigma_{22}  & \sigma_{22}^2
\end{matrix}\right)
=
\left( 
\begin{matrix}
1.1^2 & 0.6 \times 1.1 \times 1.5 \\
0.6 \times 1.1 \times 1.5  & 1.5^2
\end{matrix}\right)\end{aligned}\right\}
(\#eq:bivariate-models-binormal-parameters)
\end{equation} 

In the following code the call to get the pdf occurs at line 10.

```{r, attr.source = ".numberLines"}
mu1 <- 1.5 # mean modality 1
mu2 <- 2.0 # mean modality 2
var1 <- 1.1^2  # variance modality 1
var2 <- 1.5^2 # variance modality 2
rho <- 0.6 # correlation between modalities 1 and 2
# construct covariance matrix Sigma
Sigma <- matrix(c(var1, rho*sqrt(var1*var2), 
                  rho*sqrt(var1*var2), var2),2)
x <- c(0.1,0.2) # the x-vector at which to evaluate pdf
pdf  <- dmvnorm(x, mean = c(mu1,mu2), sigma = Sigma)
cat("density at x1 = 0.1 and x2 = 0.2 = ", pdf, "\n")
```


The parameters describing the bivariate normal distribution are $\overrightarrow{\mu}$ and $\Sigma$. The total number of parameters is five: two means, two variances and a correlation coefficient. 



### The bivariate binormal model {#bivariate-models-binormal-formulae}

The bivariate binormal model is an extension of the bivariate model, just described, to *two truth-states*: non-diseased and diseased, each modeled separately as a bivariate normal distribution. This could potentially result in a doubling of the number of parameters but by appropriate shifting and scaling transformations one can ensure that the two means of the bivariate distribution for non-diseased cases are zeroes and the corresponding variances are unity. This reduces the total number of parameters to six: $\mu_{12}$, $\mu_{22}$, $\sigma_{12}$, $\sigma_{22}$, $\rho_1$, $\rho_2$. Here $\mu_{12}$, $\mu_{22}$ are the means for diseased cases for modality 1 and modality 2, respectively, $\sigma_{12}^2$, $\sigma_{22}^2$ are the corresponding variances and $\rho_1$, $\rho_2$ are the correlations between the two modalities for non-diseased and diseased cases, respectively. 

> Notation: when there are two subscripts the first subscript refers to the modality and the second to the truth state. When there is only one subscript it refers to the truth state.


The bivariate binormal parameters are:


\begin{equation} 
\left.\begin{aligned}
\overrightarrow{
\mu_1}&=
\left( \begin{matrix}
0 \\
0
\end{matrix}
\right)\\
\overrightarrow{
\mu_2}&=
\left( \begin{matrix}
\mu_{12} \\
\mu_{22}
\end{matrix}
\right)\\
\Sigma_1&=
\left( 
\begin{matrix}
1 & \rho_1 \\
\rho_1  & 1
\end{matrix}
\right) \\
\Sigma_2 &= \left( 
\begin{matrix}
\sigma_{12}^2 & \rho_2 \sigma_{12} \sigma_{22} \\
\rho_2 \sigma_{12} \sigma_{22}  & \sigma_{22}^2
\end{matrix}
\right)
\end{aligned}\right\}
(\#eq:bivariate-models-binormal-all-parameters)
\end{equation} 



The decision variable is $z_{ik_tt}$ where the $i$ subscript corresponds to the two modalities and the $t$ subscript corresponds to the two truth states. The paired-ratings $\left( z_{1k_11},z_{2k_11} \right)$ and  $\left( z_{1k_22},z_{2k_22} \right)$, corresponding to z-samples from non-diseased and diseased cases, respectively, are abbreviated to $\overrightarrow{z_{1k_tt}}$ (the vectorization always "condenses" the two modalities):
 
 
\begin{equation} 
\overrightarrow{z_{k_tt}}=
\left( \begin{matrix}
z_{1k_tt}  \\
z_{2k_tt}
\end{matrix} \right)
(\#eq:bivariate-models-binormal-notation)
\end{equation} 


<!-- The sampling for each modality is as follows: -->


<!-- \begin{equation} -->
<!-- \left.\begin{aligned} -->
<!-- z_{k_11} &\sim  N\left( 0, 1 \right) \\ -->
<!-- z_{k_22} &\sim  N\left( \mu, \sigma^2 \right) -->
<!-- \end{aligned}\right\} -->
<!-- (\#eq:univariate-binormal-model-sampling) -->
<!-- \end{equation}  -->


<!-- where the parameters $\mu$ and $\sigma$ are of course modality dependent.  -->

$\overrightarrow{z_{k_tt}}$ is sampled as follows:



\begin{equation}
\overrightarrow{z_{k_tt}} \sim  N_2\left( \overrightarrow{\mu_t}, \Sigma_t \right)
(\#eq:bivariate-models-binormal-sampling)
\end{equation} 



The parameters $\overrightarrow{\mu_t}, \Sigma_t$ are truth-state dependent as described in Eqn. \@ref(eq:bivariate-models-binormal-all-parameters). 


To complete the model one needs to include threshold parameters and a decision rule. Recall that for an R-rating *single* modality ROC task with allowed ratings $r = 1, 2, ..., \text{R}$, one needs $\text{R}-1$ thresholds $\zeta_1,\zeta_2,...,\zeta_{\text{R}-1}$. Defining $\zeta_0 = -\infty$ and $\zeta_{\text{R}} = +\infty$ the decision rule is to label a case with rating $r$ if the realized z-sample satisfies $\zeta_{r-1} < z \le \zeta_r$. 


In the two-modality task the decision variable and the thresholds are modality dependent: i.e., $z_{1k_tt}$ and $z_{2k_tt}$ and two sets of thresholds are needed: $\zeta_{11},\zeta_{12},...,\zeta_{1 (\text{R}-1)}$ and $\zeta_{21},\zeta_{22},...,\zeta_{2 (\text{R}-1)}$. As before $\zeta_{10} = -\infty$ and $\zeta_{20} = -\infty$ and $\zeta_{1\text{R}} = +\infty$ and $\zeta_{2\text{R}} = +\infty$. The decision rule is to rate a case in modality $1$ with rating $r$ if $\zeta_{1(r-1)} < z_{1k_tt} \le \zeta_{1r}$ and the same case in modality $2$ is rated $s$ if $\zeta_{2(s-1)} < z_{2k_tt} \le \zeta_{2s}$.


### Visualizing the bivariate binormal density functions {#bivariate-models-binormal-multivariate-density-visualization}

It is helpful to visualize the pdfs. One needs two axes to depict the two z-samples and a third to depict the pdf. This is done for the non-diseased case pdf, Fig. \@ref(fig:bivariate-models-binormal-pdf-non-diseased), and the diseased case pdf, Fig. \@ref(fig:bivariate-models-binormal-pdf-diseased). 



```{r, echo=FALSE}
mu1 <- 1.5 # diseased mean modality 1
mu2 <- 2.0 # diseased mean modality 2
var1 <- (1.1)^2  # diseased variance modality 1
var2 <- (1.5)^2 # diseased variance modality 2
rho1 <- 0.3 # non-diseased correlation
rho2 <- 0.6 # diseased correlation

Sigma1 <- matrix(c(1, rho1, rho1, 1),2)
Sigma2 <- matrix(c(var1, rho2*sqrt(var1*var2), rho2*sqrt(var1*var2), var2),2)

x <- seq(-4, 6, by = 0.25)
y <- x

M <- mesh(x, y)
X <- M$x
Y <- M$y

PDF1 <- dmvnorm(cbind(as.vector(X), as.vector(Y)), mean = c(0,0), sigma = Sigma1)
dim(PDF1) <- c(length(x), length(y))

PDF2 <- dmvnorm(cbind(as.vector(X), as.vector(Y)), mean = c(mu1, mu2), sigma = Sigma2)
dim(PDF2) <- c(length(x), length(y))

scene <- list(camera = list(eye = list(x = -1.25, y = -2, z = 1.25)))
p1 <- plot_ly(x = x, y = y, z = PDF1, type = "surface") %>% layout(scene=scene)
p2 <- plot_ly(x = x, y = y, z = PDF2, type = "surface") %>% layout(scene=scene)
```


```{r echo=FALSE, bivariate-models-binormal-pdf-non-diseased, fig.cap="Plot of the bivariate binormal pdf function for non-diseased cases for $\\rho_1 = 0.3$.", fig.show='hold'}
p1
```


```{r echo=FALSE, bivariate-models-binormal-pdf-diseased, fig.cap="Plot of the bivariate binormal pdf function for diseased cases for $\\mu_{12} = 1.5$, $\\mu_{22} = 2.0$, $\\sigma_{12} = 1.1$, $\\sigma_{22} = 1.5$ and $\\rho_2 = 0.6$.", fig.show='hold'}
p2
```


Package `plotly` [@R-plotly] provides a visualization technique. It is interactive: by dragging the cursor over the plot one can visualize it from different angles. 


The non-diseased case pdf is centered at (0,0) and has unit variance in each modality and correlation $\rho_1$. The diseased case pdf is centered at $(\mu_{12},\mu_{22})$, has variances $(\sigma_{12}^2, \sigma_{22}^2)$ and correlation $\rho_2$.



### Estimating bivariate binormal model parameters {#bivariate-models-binormal-multivariate-density-estimation}

In Chapter \@ref(binormal-model) a method for estimating the parameters of the univariate binormal model was described. The method involved maximizing the likelihood function, i.e., the probability of the observed data as a function of the model parameters. The likelihood function was maximized with respect to these parameters. The values of the parameters at the maximum are the maximum-likelihood estimates (MLEs).

With a bivariate model one is dealing with six non-threshold parameters $\overrightarrow{\mu_t}, \Sigma_t$ plus threshold parameters for each modality. Again, the starting point is the likelihood function, i.e., the probability of the observed data as a function of the parameter values. The non-diseased counts in bin $r$ of the first modality and bin $s$ of the second modality is denoted by $K_{rs1}$ (i.e., the binning indices occur before the truth index). The corresponding diseased counts are denoted  $K_{rs2}$. Each case yields two integer ratings, $r$ and $s$. To construct the matrix $K_{rs1}$ one starts with a zero-initialized R x R matrix, then one increments the cell at row $r$ and column $s$ by unity for each non-diseased case that received a $r$ rating in the first modality and an $s$ rating in the second modality. The procedure is repeated for the diseased cases yielding $K_{rs2}$.

For non-diseased cases, the probability of a z-sample in bin r of the first modality and bin s of the second modality is determined by the “volume” under the bivariate distribution $N_2(\overrightarrow {\mu_{12}}, \sigma_{12})$ between modality-1 thresholds $\zeta_{1(r-1)}$ and $\zeta_{1r}$, and between modality-2 thresholds $\zeta_{2(s-1)}$ and $\zeta_{2s}$. For diseased cases the corresponding probability is the volume under the bivariate distribution $N_2(\overrightarrow {\mu_{22}}, \sigma_{22})$ between the same thresholds. The probabilities can be calculated using the `pmvnorm()` function, with appropriate parameters, in R package [@R-mvtnorm].    

The probability of observing $K_{rs1}$ non-diseased and $K_{rs2}$ diseased counts in bin $r$ in the first modality and bin $s$ in the second modality is:
 

\begin{equation} 
\prod_{t=1}^{2}\left ( p_{rst} \right )^{K_{rst}}
\end{equation} 


The logarithm of the likelihood function is given by (neglecting a combinatorial factor that does not depend on the parameters):

\begin{equation} 
LL\left ( \mu_{12}, \mu_{22}, \sigma_{12}, \sigma_{22}, \rho_1, \rho_2, \overrightarrow{\zeta_1},\overrightarrow{\zeta_2} \right ) = \sum_{t=1}^{2}\sum_{s=1}^{R}\sum_{r=1}^{R} K_{rst} \log(p_{rst})
\end{equation} 


The maximum likelihood estimates of the parameters are obtained by maximizing the LL function [@metz1980statistical, @metz1984new] which is implemented in CORROC2. The software measures ratings-correlations at the underlying z-sample level. Much as I have emphasized that ratings are not "hard" numbers the CORROC2 estimated correlations are valid because the algorithm models the ratings as continuous variables and estimates the correlation based on the bivariate binormal model.

### Comments on the bivariate binormal model

CORROC2 is one of the relatively under-utilized tools developed by Prof. Charles E. Metz. There are only four publications describing it TBA 4-6,8 and two of them are difficult to find5,8, nor has the software been maintained on a level comparable to ROCFIT. For example, a method for assessing the goodness of the fit is currently not implemented. With $R^2$ cells it is almost impossible to maintain at least five counts per cell. 

One reason for the relative under-utilization of CORROC2 could be that it is not designed to analyze multiple readers interpreting a common set of cases in two or more modalities i.e., MRMC datasets. For example, in a study in which CORROC2 was used9, four readers interpreted cases in four modalities. With four modalities, there are six possible combinations (4x3/2), so a conservative Bonferroni type correction for the p-value would be to divide 0.05 by 6. For each reader CORROC2 yields a p-value for the difference between the chosen pairs of modalities. If all readers agree, then there is an unambiguous answer, but the method does not allow for correlations between different readers, which undoubtedly leads to loss of power. More fundamentally, it does not address the question of interest: when averaged over all four readers, are the figures of merit in the four modalities different. 

It is possible to analyze multiple reader multiple modality MRMC-ROC datasets without actually using CORROC2. In chapters Chapter 09 and Chapter 10, it was shown how one analyzes such datasets using the empirical AUCs. Alternatively, one could estimate AUC using the univariate binormal model software (e.g., ROCFIT, or more modern software). The correlations in the resulting AUC values – i.e., FOM  correlations as distinct from ratings correlations - are explicitly accounted for in the significance testing procedure, i.e., the procedure it is not concerned with ratings-level correlations. 

The biggest weakness of CORROC2 is its dependence on the underlying binormal model which, as we have seen, is susceptible to improper ROC fits and degeneracy problems. 

 

CORROC2 was developed ca. 1980 by Metz, Wang and Kronman 5,10. Subsequent revisions to the program were made by Jong-Her Shen and more recently by Benjamin Herman6,7. Its impact cannot be overstated. There are well in excess of 116 citations to this software. One reason is that, at that time, it was the only software allowing analysis of paired datasets. However, no advances have been made in the intervening 3 decades, which would allow fitting, for example, proper ROC curves to paired - and possibly degenerate - datasets. Part of the reason for this neglect is the shift in emphasis to empirical AUC based analysis, which does not require parametric modeling or curve fitting – one simply calculates the trapezoidal AUC. However, empirical AUC based analysis has its own limitations, and pursuing an improvement over the parametric approach that removes the current limitations of CORROC2 would, in the author's judgment, quite apart from the specific interest in developing realistic simulators, be of scientific interest.

As a final note, at the time of writing, 4/30/17, an extension of CORROC2 has been published1 [@zhai2017bivariate]. It is called CORCBM, for correlated CBM. Details are in a document CORCBM.pdf in the online supplementary material directory corresponding to this chapter. The title of the publication is: "A bivariate contaminated binormal model for robust fitting of proper ROC curves to a pair of correlated, possibly degenerate, ROC datasets". It replaces the bivariate binormal model with the bivariate contaminated binormal model; hence its name CORCBM, for correlated CBM. Since CBM was designed to fit practically any single dataset, including degenerate ones, CORCBM is likewise able to fit practically any paired dataset. An application of CORCBM to calibrating a simulator to a data set containing single-modality multiple-reader ratings is described in Chapter 23.

## The bivariate contaminated binormal model {#bivariate-models-contaminated-binormal} 

The bivariate contaminated binormal model (BCBM) is the bivariate extension of the univariate contaminated binormal model described in Chapter \@ref(proper-roc-models). Corresponding to the two truth states the BCBM is defined by two bivariate distributions. Following the notation in Eqn. \@ref(eq:bivariate-models-binormal-notation), for case $k_tt$ the bivariate distribution yields two samples $z_{1k_tt}$ and $z_{2k_tt}$. 


### Non-diseased cases


For non-diseased cases the sampling is as follows:


\begin{equation}
\overrightarrow{z_{k_11}} \sim  N_2\left( \overrightarrow{\mu_1}, \Sigma_1 \right)
(\#eq:bivariate-models-binormal-sampling-teq1)
\end{equation} 


where 


\begin{equation} 
\left.\begin{aligned}
\overrightarrow{
\mu_1}&=
\left( \begin{matrix}
0 \\
0
\end{matrix}
\right)\\
\Sigma_1&=
\left( 
\begin{matrix}
1 & \rho_1 \\
\rho_1  & 1
\end{matrix}
\right) \\
\end{aligned}\right\}
(\#eq:bivariate-models-cbm-non-diseased)
\end{equation}


### Diseased cases

Recall, Eqn. \@ref(eq:proper-roc-models-cbm-pdfd), that in the (univariate) CBM, for diseased cases the pdf is a mixture of two scaled unit variance distributions, one centered at zero and the other at $\mu$ that integrate (i.e., via the scaling factors) to $(1-\alpha)$ and $\alpha$, respectively. For diseased cases the extension to bivariate sampling needs to account for the possibility that the scaling factors can be different in the two modalities, modeled by $\alpha_1$ and $\alpha_2$ and the z-sample means for cases where the disease is visible can be different in the two modalities, modeled by $\mu_{12}$ and $\mu_{22}$. The scaling factors and correlations are modeled as described next:

1. The disease is not visible in either modality. The appropriate distribution is a scaled bivariate $N_2$ distribution centered at $(0,0)$ with correlation $\rho_{00}$ whose pdf integrates to $(1-\alpha_1)(1-\alpha_2)$.  
    
1. The disease is visible in modality 1 but not visible in modality 2. The appropriate distribution is a scaled bivariate $N_2$  distribution centered at $(\mu_{12},0)$ with correlation $\rho_{10}$ whose pdf integrates to $\alpha_1(1-\alpha_2)$.
    
1. The disease is not visible in modality 1 but is visible in modality 2. The appropriate distribution is a scaled bivariate $N_2$ distribution centered at $(0,\mu_{22})$ with correlation $\rho_{01}$ whose pdf integrates to $(1-\alpha_1)\alpha_2$.
    
1. The disease is visible in both modalities 1 and 2. The appropriate distribution is a scaled bivariate $N_2$ distribution centered at $(\mu_{12},\mu_{22})$ with correlation $\rho_{11}$ whose pdf integrates to $\alpha_1\alpha_2$.


The means and covariance matrices for the four distributions are defined by:


\begin{equation} 
\left.\begin{aligned}
\begin{matrix}
\overrightarrow{
\mu_{00}}&=
\left( \begin{matrix}
0 \\
0
\end{matrix}
\right) 
 & \Sigma_{00}&=
\left( 
\begin{matrix}
1 & \rho_{00} \\
\rho_{00}  & 1
\end{matrix}
\right) \\
\\ 
\overrightarrow{
\mu_{10}}&=
\left( \begin{matrix}
\mu_{12} \\
0
\end{matrix}
\right)
 & \Sigma_{10}&=
\left( 
\begin{matrix}
1 & \rho_{10} \\
\rho_{10}  & 1
\end{matrix}
\right) \\
\\ 
\overrightarrow{
\mu_{01}}&=
\left( \begin{matrix}
0 \\
\mu_{22}
\end{matrix}
\right)
 & \Sigma_{01}&=
\left( 
\begin{matrix}
1 & \rho_{01} \\
\rho_{01} & 1
\end{matrix}
\right) \\
\\ 
\overrightarrow{
\mu_{11}}&=
\left( \begin{matrix}
\mu_{12} \\
\mu_{22}
\end{matrix}
\right)
 & \Sigma_{11}&=
\left( 
\begin{matrix}
1 & \rho_{11} \\
\rho_{11}  & 1
\end{matrix}
\right) \\ 
\end{matrix}
\end{aligned}\right\}
(\#eq:bivariate-models-cbm-diseased)
\end{equation}


Therefore, the pdf of the diseased case bivariate distribution is:


\begin{equation} 
\left.\begin{aligned}
\text{pdf}\left (z_{1k_22},z_{2k_22}  \right ) =
&(1-\alpha_1)(1-\alpha_2)~~\text{pdf}\left ( z_{1k_22},z_{2k_22} ~| ~\overrightarrow{\mu_{00}}, \Sigma_{00}\right )\\ 
+& \alpha_1(1-\alpha_2)~~\text{pdf}\left ( z_{1k_22},z_{2k_22} ~| ~ \overrightarrow{\mu_{10}}, \Sigma_{10}\right )\\
+& (1-\alpha_1)\alpha_2~~\text{pdf}\left ( z_{1k_22},z_{2k_22} ~| ~ \overrightarrow{\mu_{01}}, \Sigma_{01}\right )\\ 
+& \alpha_1\alpha_2~~\text{pdf}\left ( z_{1k_22},z_{2k_22} ~| ~\overrightarrow{\mu_{11}}, \Sigma_{11}\right )\\ 
\end{aligned}\right\}
(\#eq:bivariate-models-cbm-pdf-diseased)
\end{equation}

In this equation $\text{pdf}\left ( z_{1k_22},z_{2k_22} ~| ~\overrightarrow{\mu}, \Sigma \right )$ denotes the bivariate normal pdf function with the specified mean-vector and covariance matrix, as defined in Eqn. \@ref(eq:bivariate-models-binormal-density-function).  



```{r}
mu_1 <- 3.5
mu_2 <- 3

rho1 <- 0.3
rho4 <- 0.8

alpha_1 <- 0.5
alpha_2 <- 0.6

```

```{r echo=FALSE}
mu_00 <- c(0, 0)
mu_01 <- c(0, mu_2)
mu_10 <- c(mu_1, 0)
mu_11 <- c(mu_1, mu_2)

rho2 <- (rho1 + rho4) / 2
rho3 <- rho2

sigma1 <- rbind(c(1, rho1), c(rho1, 1))
sigma2 <- rbind(c(1, rho2), c(rho2, 1))
sigma3 <- rbind(c(1, rho3), c(rho3, 1))
sigma4 <- rbind(c(1, rho4), c(rho4, 1))

x <- seq(-3, 6, by = 0.05)
y <- x

M <- mesh(x, y)
X <- M$x
Y <- M$y
pdf <- (1 - alpha_1) * (1 - alpha_2) * dmvnorm(cbind(as.vector(X), as.vector(Y)), sigma = sigma1) + 
  (1 - alpha_1) * alpha_2 * dmvnorm(cbind(as.vector(X), as.vector(Y)), mean = mu_01, sigma = sigma2) + 
  alpha_1 * (1 - alpha_2) * dmvnorm(cbind(as.vector(X), as.vector(Y)), mean = mu_10, sigma = sigma3) + 
  alpha_1 * alpha_2 * dmvnorm(cbind(as.vector(X), as.vector(Y)), mean = mu_11, sigma = sigma4)
dim(pdf) <- c(length(x), length(y))

scene <- list(camera = list(eye = list(x = -1.25, y = -2, z = 1.25)))
# https://plotly.com/python/3d-camera-controls/
# scene <- list(camera = list(eye = list(x = 0, y = 0, z = 1)))

p <- plot_ly(x = x, y = y, z = pdf, type = "surface") %>% layout(scene=scene)
#print(hide_colorbar(p))
```




```{r bivariate-models-cbm-diseased, fig.cap="Interactive surface plot showing the 4 distributions that are needed to describe diseased case sampling.", fig.show='hold', fig.align = "center", echo = F}
p
```


Fig. \@ref(fig:bivariate-models-cbm-diseased) shows this pdf function as a surface plot in which four peaks are seen. This plot corresponds to the following values: $\mu_1 = 3.5$, $\mu_2 = 3$, $\rho_1 = 0.3$, $\rho_2 = 0.8$, $\alpha_1 = 0.5$ and $\alpha_2 = 0.6$.


[@zhai2017bivariate] proves that with the above mixing fractions the pdf and CDF (cumulative distribution function) of the marginal distributions for diseased cases in modalities 1 and 2 have the same structure as in the univariate CBM, i.e., either condition, viewed in isolation, has the same sampling behavior as in the univariate CBM.


The above model has four correlations in contrast to the bivariate binormal model which has two correlations. For parsimony the following assumptions are made: 

1. When the disease is invisible in both modalities the correlation is the same as that for non-diseased cases, i.e., $\rho_{00} = \rho_1$. 

1. When the disease is visible in only one modality the correlation is the mean of the non-diseased cases correlation and the correlation where disease is visible in both conditions, i.e., $\rho_{10} = \rho_{01} = (\rho_1+\rho_2)/2$. 

1. When the disease is visible in both modalities the correlation is $\rho_{11} \equiv \rho_2$. 


### Estimation

This follows the procedure described previously for the correlated binormal model (i.e., CORROC2). One introduces binning thresholds, defines the likelihood function and applies a procedure for maximizing it. Details are in [@zhai2017bivariate] which also shows applications to two real datasets and a simulation study.


### Figures

Fig. \@ref(fig:bivariate-models-figures1); CORCBM fits for Van Dyke data, modality 1 reader 4. due to degeneracy CORROC2 failed to converge.


```{r bivariate-models-figures1, echo=FALSE,out.width="50%", fig.cap="VanDyke dataset, modality 1 reader 4; due to degeneracy CORROC2 failed and only CORCBM plots are shown.", fig.show='hold'}

knitr::include_graphics(c("images/corcbm/plots/VanDykeM1R4.png","images/corcbm/plots/VanDykeM2R4.png"))
``` 


Fig. \@ref(fig:bivariate-models-figures2); CORROC2 and CORCBM fits for Van Dyke data, modality 1 reader 5.

```{r bivariate-models-figures2, echo=FALSE,out.width="50%", fig.cap="VanDyke dataset, modality 1 reader 5; both CORROC2 and CORCBM plots are shown. Note that CORCBM has higher AUC than CORROC2.", fig.show='hold'}

knitr::include_graphics(c("images/corcbm/plots/VanDykeM1R5.png","images/corcbm/plots/VanDykeM2R5.png"))
``` 


Fig. \@ref(fig:bivariate-models-figures3); simulation parameters were $\mu_1 = 1.5$, $\mu_2 = 3$, $\alpha_1 = 0.4$, $\alpha_2 = 0.7$,  $\rho_1 = 0.3$,   $\rho_2 = 0.8$.   


```{r bivariate-models-figures3, echo=FALSE,out.width="50%", fig.cap="CORCBM fits to simulated data for two modalities or \"conditions\". Top-left: 50 non-diseased and 50 diseased cases; Top-right: 100 non-diseased and 100 diseased cases;  Bottom-left: 1000 non-diseased and 1000 diseased cases;  Bottom-right: 5000 non-diseased and 5000 diseased cases. For 5000-5000 cases the operating points are almost exactly fitted by CORCBM.", fig.show='hold'}

knitr::include_graphics(c("images/corcbm/plots/Simu-50-50.png","images/corcbm/plots/Simu-100-100.png", "images/corcbm/plots/Simu-1000-1000.png", "images/corcbm/plots/Simu-5000-5000.png"))
``` 



## Discussion / Summary {#bivariate-models-binormal-corroc2-discussion}

Described is an approach to fitting single reader paired modality ROC datasets using a bivariate extension of the contaminated binormal model (CBM). Software implementing the method, CORCBM, was applied to two datasets that have been widely used to test methodological advances in ROC analysis. For comparison with an existing widely used standard, CORROC2, which implements the bivariate binormal model, was also applied to the same datasets. CORCBM was able to fit the paired data for all 9 readers (5 from the Van Dyke dataset and 4 from the Franken dataset) while CORROC2 was unable to fit one reader in the Van Dyke dataset. Inability to fit a dataset, especially for a reader whose performance is close to perfect, would tend to exclude near perfect radiologists from further data analysis – a serious shortcoming in our opinion (Vannier et al11 have reported a study where CORROC2 was unable to fit 14 out of 16 datasets). Moreover, in the current study all CORROC2 fits were improper, implying a range of predicted performance for expert radiologists below the chance diagonal, a serious shortcoming, which, while it has been corrected for unpaired dataset analysis (i.e., single reader single modality) by several methods, until now, no method existed for fitting proper ROC curves to paired datasets, a need addressed by this work. 

As stated in the Introduction, CORROC2 software has played an important role in the evolution of ROC analysis. However, it is inadequately described in the archival literature. One of the relevant papers13 is in a conference proceeding available, for a price, only from the publisher. Another key reference14 is to a version of CORROC2 FORTRAN code encapsulated into ROCKIT, which is non-open-source and no longer supported. The senior author was able to obtain one of the references13 from Mr. Benjamin Herman and Dr. Constantine Gatsonis (Benjamin Herman, private communication, 1/16/2015). This work corrects the current lack of adequate description in the archival literature on how to fit a bivariate ROC model. While the current work does not implement CORROC2, the detailed description of how the likelihood function is derived for bivariate CBM, Fig. 1 – 4, should allow one to understand how CORROC2 works, and, with appropriate modifications to the R code, re-implement CORROC2, if necessary, in open-source R code. The only difference is in the pdf of the diseased cases, which instead of four unit-variance bivariate peaks, as in bivariate CBM, Fig. 4, will consist of a single bivariate peak at   with standard deviations   and correlation parameter  . Implementation in an open-source platform, already adopted by Dr. Gallas and colleagues at the FDA (https://github.com/DIDSR/iMRMC), means that advances will survive the vagaries of the funding process and be possibly improved upon by others.

Existing methods for fitting proper ROC curves to an unpaired (i.e., univariate) dataset include the proper ROC model, implemented in PROPROC, the contaminated binormal model, also implemented in software on the University of Iowa ROC website, and the bigamma model, which while not implemented, to the best of our knowledge, is relatively easy to implement. In our opinion, extending PROPROC, a relatively complex algorithm12, whose software is not in the public domain to paired data would be a challenge. Moreover, since it is based on the binormal model, it would still be unable to yield reasonable fits to degenerate datasets. The authors have confirmed that given a dataset with 100 non-diseased and 100 diseased cases yielding a single operating point at (0, TPF), where 0 < TPF < 1, PROPROC yields AUC = 1 regardless of how small the value of TPF is, e.g., TPF = 0.01. Likewise, given a dataset yielding a single operating point at (FPF, 0), where 0 < FPF < 1, PROPROC still yields AUC = 1 regardless of how large the value of FPF is (e.g., FPF = 0.99). In contrast the CBM algorithm yields AUC = 0.5 when either TPF is small or FPF is large, which is reasonable (by design CBM does not allow AUC to fall below 0.5). If TPF is not close to zero, CBM yields the AUC under the empirical ROC defined by the single on-axis operating point, which is also reasonable. The CBM model is simpler and takes into account the physical fact that some disease may not be visible and it has no issues with fitting degenerate datasets. In our opinion, the CBM model parameters are easier to interpret than other proper ROC models, and as shown in this work, it can be extended to the bivariate situation. The R implementation of CORCBM is cross-platform and open-source and an R-function implanting this software is under development as an update to our existing R package RJafroc53.

Our interest in this problem arose from a methodology validation issue. Multiple-reader multiple case (MRMC) study designs are widely used to compare modalities. Several analysis methods have been proposed. The Dorfman Berbaum Metz method (DBM) 54 or the substantially equivalent Obuchowski and Rockette55 method, both with significant extensions by Hillis42-44,56, have been used in a few hundred publications (Prof. Kevin Berbaum, private communication, ca. 2010). With such wide usage, the results of any of which could be a critical driver of medical imaging technology, one needs to be sure that the analysis method is itself valid. Validating a methodology requires an MRMC ratings data simulator. The simulator used so far to validate DBM44 is that proposed by Roe and Metz57. This simulator has several shortcomings. (a) It assumes that the ratings are distributed like an equal-variance binormal model, which is not true for most clinical datasets (e.g., b-parameter is usually less than one). While work extending this simulator to unequal variance has been published44, CBM provides a natural explanation of the observed unequal variance. Since there are two types of disease – visible and not visible –the mixing of the two gives arise to a diseased case pdf that appears wider than a non-diseased case pdf (i.e., b-parameter is less than one). (b) The Roe-Metz simulator is out dated; the parameter values are based on datasets then available (i.e., prior to 1997). Medical imaging technology has changed substantially in the intervening decades, and modalities that did not exist then, like digital mammography10,58, breast59,60 and chest tomosynthesis61, are in wide usage in the US. There is need to update the simulator to reflect changes in technology. (c) Finally, the methodology used to arrive at the Roe and Metz parameter values, Table 1 in the referenced publication, is not clearly described. Needed is a realistic simulator that is calibrated, by a clearly defined method, to current datasets. The author's approach to this problem originally used CORROC2 to determine the different types of ratings-level correlations present in an ROC-MRMC dataset: between different readers in the same modality, between the same reader in different modalities and between different readers in different modalities. The correlations were used to design a new simulator that incorporated the measured values. However, CORROC2 frequently failed to converge and other discrepancies were found when CORROC2 was applied to newer datasets (CORROC2 gave reasonable results for the Van Dyke et al. 46 and the Franken et al. 47 datasets, but failed on almost all newer datasets). This is what led to this project.

The study has two limitations: (1) the simulation studies should be viewed as a limited validation as only one set of parameters were used and effects encountered with real data were not included. (ii) The overall goal of creating a calibrated simulator is as-yet unrealized; i.e., one does not know that solving the correlation determination issue, which was the driver for this project, will indeed lead to a calibrated simulator. 

In conclusion, CORCBM is a robust method for fitting paired ROC datasets, always yielding proper ROC curves, is able to fit degenerate datasets and has passed an initial simulation validation test.
